{% extends 'base.html' %}

{% block title %}{{ title }} - Invoice App{% endblock %}

{% block content %}
<div class="bg-white shadow sm:rounded-lg">
    <div class="px-4 py-5 sm:p-6">
        <h2 class="text-lg font-medium text-gray-900">{{ title }}</h2>
        <form id="invoice-form" method="post" class="mt-5 space-y-6">
            {% csrf_token %}

            <div class="grid grid-cols-1 gap-y-6 gap-x-4 sm:grid-cols-2">
                <div>
                    <label for="{{ form.customer_name.id_for_label }}" class="block text-sm font-medium text-gray-700">
                        Customer Name
                    </label>
                    {{ form.customer_name }}
                    {% if form.customer_name.errors %}
                    <p class="mt-2 text-sm text-red-600">{{ form.customer_name.errors.0 }}</p>
                    {% endif %}
                </div>

                <div>
                    <label for="{{ form.customer_email.id_for_label }}" class="block text-sm font-medium text-gray-700">
                        Customer Email
                    </label>
                    {{ form.customer_email }}
                    {% if form.customer_email.errors %}
                    <p class="mt-2 text-sm text-red-600">{{ form.customer_email.errors.0 }}</p>
                    {% endif %}
                </div>

                <div>
                    <label for="{{ form.billing_date.id_for_label }}" class="block text-sm font-medium text-gray-700">
                        Billing Date
                    </label>
                    {{ form.billing_date }}
                    {% if form.billing_date.errors %}
                    <p class="mt-2 text-sm text-red-600">{{ form.billing_date.errors.0 }}</p>
                    {% endif %}
                </div>

                <div>
                    <label for="{{ form.due_date.id_for_label }}" class="block text-sm font-medium text-gray-700">
                        Due Date
                    </label>
                    {{ form.due_date }}
                    {% if form.due_date.errors %}
                    <p class="mt-2 text-sm text-red-600">{{ form.due_date.errors.0 }}</p>
                    {% endif %}
                </div>
            </div>

            <div>
                <label for="{{ form.notes.id_for_label }}" class="block text-sm font-medium text-gray-700">
                    Notes
                </label>
                {{ form.notes }}
                {% if form.notes.errors %}
                <p class="mt-2 text-sm text-red-600">{{ form.notes.errors.0 }}</p>
                {% endif %}
            </div>

            <div class="mt-8">
                <div class="flex justify-between">
                    <div>
                        <h3 class="text-lg font-medium text-gray-900">Invoice Items</h3>
                    </div>
                    <div class="relative inline-block text-left">
                        <!-- Dropdown Button -->
                        <button id="dropdownButton" type="button"
                            class="inline-flex justify-center w-full rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none"
                            aria-expanded="true" aria-haspopup="true">
                            Currency
                            <svg class="-mr-1 ml-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"
                                fill="currentColor" aria-hidden="true">
                                <path fill-rule="evenodd"
                                    d="M5.23 7.21a.75.75 0 011.06.02L10 10.939l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.24a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.08z"
                                    clip-rule="evenodd" />
                            </svg>
                        </button>

                        <!-- Dropdown Menu -->
                        <div id="dropdownMenu"
                            class="origin-top-right absolute right-0 mt-2 w-96 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 hidden z-10">
                            <div class="py-1 w-full" role="menu" aria-orientation="vertical"
                                aria-labelledby="dropdownButton">
                                <a href="#"
                                    class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 currency-option"
                                    data-currency="USD" role="menuitem">USD</a>
                                <a href="#"
                                    class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 currency-option"
                                    data-currency="INR" role="menuitem">INR</a>
                                <a href="#"
                                    class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 currency-option"
                                    data-currency="EUR" role="menuitem">EUR </a>
                                <a href="#"
                                    class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 currency-option"
                                    data-currency="GBP" role="menuitem">GBP </a>
                                <a href="#"
                                    class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 currency-option"
                                    data-currency="JPY" role="menuitem">JPY</a>
                                <a href="#"
                                    class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 currency-option"
                                    data-currency="AUD" role="menuitem">AUD </a>
                                <a href="#"
                                    class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 currency-option"
                                    data-currency="CAD" role="menuitem">CAD</a>
                            </div>
                        </div>
                    </div>

                </div>
                {{ formset.management_form }}
                {% if formset.non_form_errors %}
                <div class="mt-2 text-sm text-red-600">
                    {% for error in formset.non_form_errors %}
                    <p>{{ error }}</p>
                    {% endfor %}
                </div>
                {% endif %}

                <!-- Header for invoice items -->
                <div class="grid grid-cols-1 gap-y-6 gap-x-4 sm:grid-cols-3 mb-2">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Item</label>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Quantity</label>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Unit Price (<span
                                id="currency-symbol">$</span>)</label>
                    </div>
                </div>

                <!-- Container for invoice items -->
                <div id="invoice-items">
                    {% if formset.forms %}
                    {% for form in formset %}
                    <div class="invoice-item border-b rounded p-4 mb-4">
                        <div class="grid grid-cols-1 gap-y-6 gap-x-4 sm:grid-cols-3">
                            <div>
                                {{ form.item }}
                                {% if form.item.errors %}
                                <p class="mt-2 text-sm text-red-600">{{ form.item.errors.0 }}</p>
                                {% endif %}
                            </div>
                            <div>
                                {{ form.quantity }}
                                {% if form.quantity.errors %}
                                <p class="mt-2 text-sm text-red-600">{{ form.quantity.errors.0 }}</p>
                                {% endif %}
                            </div>
                            <div>
                                {{ form.unit_price }}
                                {% if form.unit_price.errors %}
                                <p class="mt-2 text-sm text-red-600">{{ form.unit_price.errors.0 }}</p>
                                {% endif %}
                            </div>
                        </div>
                        <div class="mt-2">
                            <label class="inline-flex items-center">
                                {{ form.DELETE }}
                                <span class="ml-2 text-sm text-gray-600">Delete this item</span>
                            </label>
                        </div>
                    </div>
                    {% endfor %}
                    {% endif %}
                </div>

                <button type="button" id="add-item"
                    class="mt-4 inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                    Add Item
                </button>

                <!-- Hidden template for a new invoice item -->
                <div id="empty-form-template" class="hidden">
                    <div class="invoice-item border-b rounded p-4 mb-4">
                        <div class="grid grid-cols-1 gap-y-6 gap-x-4 sm:grid-cols-3">
                            <div>
                                {{ formset.empty_form.item }}
                            </div>
                            <div>
                                {{ formset.empty_form.quantity }}
                            </div>
                            <div>
                                {{ formset.empty_form.unit_price }}
                            </div>
                            <div class="mt-2">
                                <label class="inline-flex items-center">
                                    {{ formset.empty_form.DELETE }}
                                    <span class="ml-2 text-sm text-gray-600">Delete this item</span>
                                </label>
                            </div>
                        </div>

                    </div>
                </div>
            </div>

            <div class="flex justify-end space-x-3">
                <p id="status-error" class="mt-2 text-sm text-red-600 hidden">Please select a status.</p>
                <div class="relative inline-block text-left">
                    <button id="dropdownStatus" type="button"
                        class="inline-flex justify-center w-48 rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none"
                        aria-expanded="true" aria-haspopup="true">
                        Select Status
                        <svg class="-mr-1 ml-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"
                            fill="currentColor" aria-hidden="true">
                            <path fill-rule="evenodd"
                                d="M5.23 7.21a.75.75 0 011.06.02L10 10.939l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.24a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.08z"
                                clip-rule="evenodd" />
                        </svg>
                    </button>
                    <div id="dropdownStatusMenu"
                        class="origin-top-right absolute bottom-full right-0 mb-2 w-56 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 hidden z-10">
                        <div class="py-1" role="menu" aria-orientation="vertical" aria-labelledby="dropdownStatus">
                            <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 status-option" data-status="pending" role="menuitem">Pending</a>
                            <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 status-option" data-status="completed" role="menuitem">Completed</a>
                            <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 status-option" data-status="canceled" role="menuitem">Canceled</a>
                        </div>
                    </div>
                </div>
                <a href="{% url 'invoices:dashboard' %}"
                    class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                    Cancel
                </a>
                <button type="submit"
                    class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-primary hover:bg-blue-700">
                    Save Invoice
                </button>
            </div>
              <!-- Hidden input to the selected status -->
              <input type="hidden" id="status-input" name="status" value="">
        </form>
    </div>
</div>

<script>
    // Set USD as default currency
    document.getElementById('dropdownButton').textContent = 'USD';

    const currencySymbols = {
        'USD': '$',
        'INR': '₹',
        'EUR': '€',
        'GBP': '£',
        'JPY': '¥',
        'AUD': 'A$',
        'CAD': 'C$'
    };

    // Function to update currency symbols
    function updateCurrencySymbols(currency) {
        const symbol = currencySymbols[currency];
        document.getElementById('currency-symbol').textContent = symbol;
        document.querySelectorAll('.currency-symbol').forEach(el => {
            el.textContent = symbol;
        });
    }

    document.getElementById('add-item').addEventListener('click', function () {
        const itemsContainer = document.getElementById('invoice-items');
        const totalForms = document.getElementById('id_form-TOTAL_FORMS');
        let formNum = parseInt(totalForms.value);

        // Get the hidden empty form template HTML
        const template = document.getElementById('empty-form-template').innerHTML;
        // Replace the __prefix__ placeholder with the current form number
        const newFormHtml = template.replace(/__prefix__/g, formNum);

        // Create a temporary container to hold the new form markup
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = newFormHtml;
        // Append the new form to the invoice items container
        itemsContainer.appendChild(tempDiv.firstElementChild);

        // Increment the TOTAL_FORMS count
        totalForms.value = formNum + 1;
    });

    document.getElementById('dropdownButton').addEventListener('click', function () {
        const menu = document.getElementById('dropdownMenu');
        // Toggle the 'hidden' class to show/hide the dropdown
        menu.classList.toggle('hidden');
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', function (event) {
        const dropdownButton = document.getElementById('dropdownButton');
        const dropdownMenu = document.getElementById('dropdownMenu');

        if (!dropdownButton.contains(event.target) && !dropdownMenu.contains(event.target)) {
            dropdownMenu.classList.add('hidden');
        }
    });

    document.getElementById('dropdownStatus').addEventListener('click', () => {
        const dropdownStatusMenu = document.getElementById('dropdownStatusMenu');
        dropdownStatusMenu.classList.toggle('hidden');
    });

    document.addEventListener('click', function (e) {
        const dropdownStatus = document.getElementById('dropdownStatus');
        const dropdownStatusMenu = document.getElementById('dropdownStatusMenu');
        if (!dropdownStatus.contains(e.target) && !dropdownStatusMenu.contains(e.target)) {
            dropdownStatusMenu.classList.add('hidden');
        }
    });

    // Store original prices for conversion
    let originalPrices = new Map();

    // Function to update prices based on selected currency
    async function updatePrices(selectedCurrency) {

        updateCurrencySymbols(selectedCurrency);
        if (selectedCurrency === 'USD') {
            // If USD is selected, restore original prices
            document.querySelectorAll('.invoice-item').forEach(item => {
                const unitPriceInput = item.querySelector('input[name$="-unit_price"]');
                const originalPrice = originalPrices.get(unitPriceInput.id);
                if (originalPrice) {
                    unitPriceInput.value = originalPrice;
                }
            });
            return;
        }

        try {
            // Fetch exchange rate from API
            const response = await fetch(`https://api.exchangerate-api.com/v4/latest/USD`);
            const data = await response.json();
            const rate = data.rates[selectedCurrency];

            // Update all unit prices
            document.querySelectorAll('.invoice-item').forEach(item => {
                updateCurrencySymbols(selectedCurrency);
                const unitPriceInput = item.querySelector('input[name$="-unit_price"]');
                if (!originalPrices.has(unitPriceInput.id)) {
                    originalPrices.set(unitPriceInput.id, unitPriceInput.value);
                }
                const originalPrice = originalPrices.get(unitPriceInput.id);
                if (originalPrice) {
                    const convertedPrice = (parseFloat(originalPrice) * rate).toFixed(2);
                    unitPriceInput.value = convertedPrice;
                }
            });
        } catch (error) {
            console.error('Error fetching exchange rates:', error);
            alert('Error converting currency. Please try again later.');
        }
    }

    // Add click handlers for currency options
    document.querySelectorAll('.currency-option').forEach(option => {
        option.addEventListener('click', function (e) {
            e.preventDefault();
            const selectedCurrency = this.dataset.currency;
            document.getElementById('dropdownButton').textContent = selectedCurrency;
            document.getElementById('dropdownMenu').classList.add('hidden');
            updatePrices(selectedCurrency);
        });
    });

    // Add click handlers for status options
    document.querySelectorAll('.status-option').forEach(option => {
        option.addEventListener('click', function(e) {
            e.preventDefault();
            const selectedStatus = this.dataset.status;
            const displayText = this.textContent;
            document.getElementById('dropdownStatus').textContent = displayText;
            document.getElementById('status-input').value = selectedStatus;
            document.getElementById('dropdownStatusMenu').classList.add('hidden');
            // Remove error message if it exists
            const errorEl = document.getElementById('status-error');
            if (errorEl) {
            errorEl.classList.add('hidden');
            }
        });
    });

    
    // Prevent form submission if status is not selected
  document.getElementById('invoice-form').addEventListener('submit', function(e) {
    const statusValue = document.getElementById('status-input').value;
    if (!statusValue) {
      e.preventDefault();
      document.getElementById('status-error').classList.remove('hidden');
    }
  });
</script>
{% endblock %}